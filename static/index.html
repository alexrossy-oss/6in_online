<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>6-In Online</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .row { margin: 10px 0; }
    input { padding: 8px; font-size: 16px; }
    button { padding: 8px 14px; font-size: 16px; cursor: pointer; }
    #status { margin-top: 10px; font-weight: bold; }

    #players, #game, #diceBox, #boards {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      max-width: 640px;
    }

    li { margin: 4px 0; }
    .turn { font-size: 18px; margin-top: 10px; }

    .dice { display: flex; gap: 12px; margin-top: 10px; }

    .die {
      width: 48px;
      height: 48px;
      border: 2px solid #222;
      border-radius: 8px;
      background: #fff;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      padding: 6px;
      box-sizing: border-box;
    }

    .pip {
      width: 8px;
      height: 8px;
      background: #000;
      border-radius: 50%;
      justify-self: center;
      align-self: center;
      visibility: hidden;
    }

    .pip.on { visibility: visible; }

    .player-board {
      margin-top: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .player-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-weight: bold;
    }

    .me-badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #999;
      color: #333;
    }

    .tiles {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .tile {
      width: 44px;
      height: 44px;
      border: 2px solid #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      background: #fff;
      user-select: none;
    }

    .tile.covered {
      background: #4caf50;
      color: white;
    }

    .tile.clickable {
      outline: 3px solid rgba(0,0,0,0.10);
      cursor: pointer;
    }

    .tile.clickable:active {
      transform: scale(0.97);
    }

    .hint {
      margin-top: 8px;
      color: #555;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h2>6-In Online</h2>

  <div id="lobby">
    <div class="row">
      <label>Room Code:</label><br/>
      <input id="room" placeholder="Example: A3F9 (or leave blank)" />
    </div>

    <div class="row">
      <label>Your Name:</label><br/>
      <input id="name" placeholder="Alex" />
    </div>

    <div class="row">
      <button id="joinBtn">Join Room</button>
      <button id="leaveBtn" disabled>Leave</button>
    </div>
  </div>

  <div id="status">Connecting...</div>

  <div id="players">
    <div><b>Players:</b> <span id="count">0</span></div>
    <ul id="playerList"></ul>
  </div>

  <div id="game">
    <button id="startBtn">Start Game</button>
    <button id="rollBtn" disabled>Roll Dice</button>
    <button id="endTurnBtn" disabled>End Turn</button>

    <div class="turn">
      <b>Current Turn:</b>
      <span id="currentTurn">—</span>
    </div>

    <div class="hint" id="hint">Hint: Roll, then tap numbers on YOUR board to cover them (if you have matching dice).</div>
  </div>

  <div id="diceBox">
    <b>Dice:</b>
    <div class="dice" id="dice"></div>
  </div>

  <div id="boards">
    <b>Boards:</b>
    <div id="boardsContainer"></div>
  </div>

  <script>
    let ws = null;
    let myName = "";

    let lastGame = {
      started: false,
      current_turn: null,
      dice: [],
      rolled_this_turn: false,
      boards: {}
    };

    const roomInput = document.getElementById("room");
    const nameInput = document.getElementById("name");
    const joinBtn = document.getElementById("joinBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const startBtn = document.getElementById("startBtn");
    const rollBtn = document.getElementById("rollBtn");
    const endTurnBtn = document.getElementById("endTurnBtn");

    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("playerList");
    const countEl = document.getElementById("count");
    const currentTurnEl = document.getElementById("currentTurn");
    const diceEl = document.getElementById("dice");
    const boardsEl = document.getElementById("boardsContainer");

    const pipMap = {
      1: [4],
      2: [0, 8],
      3: [0, 4, 8],
      4: [0, 2, 6, 8],
      5: [0, 2, 4, 6, 8],
      6: [0, 2, 3, 5, 6, 8],
    };

    function setStatus(text) { statusEl.textContent = text; }

    function renderPlayers(players) {
      listEl.innerHTML = "";
      countEl.textContent = players.length;
      players.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p;
        listEl.appendChild(li);
      });
    }

    function drawDie(value) {
      const die = document.createElement("div");
      die.className = "die";
      for (let i = 0; i < 9; i++) {
        const pip = document.createElement("div");
        pip.className = "pip";
        if (pipMap[value]?.includes(i)) pip.classList.add("on");
        die.appendChild(pip);
      }
      return die;
    }

    function renderDice(dice) {
      diceEl.innerHTML = "";
      dice.forEach(v => diceEl.appendChild(drawDie(v)));
    }

    function canCoverNow() {
      return (
        lastGame.started &&
        lastGame.current_turn === myName &&
        lastGame.rolled_this_turn &&
        Array.isArray(lastGame.dice) &&
        lastGame.dice.length > 0
      );
    }

    function renderBoards(boards) {
      boardsEl.innerHTML = "";
      const isMyTurn = lastGame.current_turn === myName;

      for (const player in boards) {
        const pb = document.createElement("div");
        pb.className = "player-board";

        const header = document.createElement("div");
        header.className = "player-title";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = player;

        header.appendChild(nameSpan);

        if (player === myName) {
          const badge = document.createElement("span");
          badge.className = "me-badge";
          badge.textContent = "YOU";
          header.appendChild(badge);
        }

        pb.appendChild(header);

        const tiles = document.createElement("div");
        tiles.className = "tiles";

        for (let i = 1; i <= 6; i++) {
          const t = document.createElement("div");
          t.className = "tile";
          t.textContent = i;

          const covered = !!boards[player][i];
          if (covered) t.classList.add("covered");

          // clickable only on YOUR board, on YOUR turn, after roll
          const clickable =
            player === myName &&
            isMyTurn &&
            canCoverNow() &&
            !covered &&
            lastGame.dice.includes(i);

          if (clickable) {
            t.classList.add("clickable");
            t.onclick = () => {
              ws.send(JSON.stringify({ type: "cover", n: i }));
            };
          }

          tiles.appendChild(t);
        }

        pb.appendChild(tiles);
        boardsEl.appendChild(pb);
      }
    }

    function connect() {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}/ws`);

      ws.onopen = () => setStatus("Connected. Join a room.");
      ws.onclose = () => setStatus("Disconnected.");
      ws.onerror = () => setStatus("WebSocket error.");

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);

        if (msg.type === "room_state") {
          renderPlayers(msg.players);
          joinBtn.disabled = true;
          leaveBtn.disabled = false;
          setStatus(`In room ${msg.room}`);
        }

        if (msg.type === "game_state") {
          lastGame = msg;

          currentTurnEl.textContent = msg.current_turn || "—";
          renderDice(msg.dice || []);
          renderBoards(msg.boards || {});

          const isMyTurn = msg.current_turn === myName;
          rollBtn.disabled = !isMyTurn || msg.rolled_this_turn;
          endTurnBtn.disabled = !isMyTurn;
        }
      };
    }

    joinBtn.onclick = () => {
      const room = roomInput.value.trim().toUpperCase();
      const name = nameInput.value.trim();
      if (!name) return alert("Enter your name.");
      myName = name;
      ws.send(JSON.stringify({ type: "join", room, name }));
    };

    leaveBtn.onclick = () => {
      ws.send(JSON.stringify({ type: "leave" }));
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      currentTurnEl.textContent = "—";
      renderDice([]);
      boardsEl.innerHTML = "";
    };

    startBtn.onclick = () => ws.send(JSON.stringify({ type: "start_game" }));
    rollBtn.onclick = () => ws.send(JSON.stringify({ type: "roll" }));
    endTurnBtn.onclick = () => ws.send(JSON.stringify({ type: "end_turn" }));

    connect();
  </script>
</body>
</html>
